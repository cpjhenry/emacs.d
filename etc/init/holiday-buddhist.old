;;; holiday-buddhist.el --- create holiday entries for Buddhist (Theravadin) holidays.
;;; commentary:

;;; code:
(require 'calendar)
(require 'lunar)

(defun holiday-named-full-moons (&rest month-name-pairs)
  "Return holidays marking the *first full moon* of selected months in YEAR.

MONTH-NAME-PAIRS have these forms:

  (MONTH \"Full Moon Name\")
  (MONTH \"Full Moon Name\" \"Next-Day Name\")

Only MONTH = 7 (July) is expected to use the optional third
element, but the function is general enough to permit it in any
month.

Examples:
  (holiday-named-full-moons year
    '(2  \"Snow Moon\")
    '(5  \"Flower Moon\")
    '(7  \"Buck Moon\" \"Buck Moon Retreat\")
    '(10 \"Hunter's Moon\"))"

  (interactive)
  (let* ((full-moon-phase-index 2)
         holidays
	 (year (string-to-number (format-time-string "%Y"))))
    (dolist (mn month-name-pairs (nreverse holidays))
      (pcase-let ((`(,month ,full-name . ,maybe-next) mn))
        (let (candidates)
          ;; Gather all full moons in this month
          (dolist (phase (lunar-phase-list month year))
            (let* ((date (car phase))          ; (month day year)
                   (mon  (nth 0 date))
                   (yr   (nth 2 date))
                   (phase-index (nth 2 phase)))
              (when (and (= mon month)
                         (= yr year)
                         (= phase-index full-moon-phase-index))
                (push date candidates))))
          ;; Choose earliest full moon
          (when candidates
            (let* ((first (car (sort candidates
                                     (lambda (a b)
                                       (< (nth 1 a) (nth 1 b))))))
                   ;; Always generate the main full-moon holiday
                   (first-holiday (list first full-name)))
              (push first-holiday holidays)

              ;; If a custom next-day name was supplied, create next-day holiday
              (when maybe-next
                (let* ((next-name (car maybe-next))
                       (next-abs (1+ (calendar-absolute-from-gregorian first)))
                       (next-date (calendar-gregorian-from-absolute next-abs)))
                  (push (list next-date next-name) holidays))))))))))

(defmacro define-full-moon-holidays (name &rest month-entries)
  "Define a holiday function NAME that returns named full-moon holidays.

Each MONTH-ENTRY must be of the form:
  (MONTH \"Full Moon Name\")
or
  (MONTH \"Full Moon Name\" \"Next-Day Name\")

For July or any month, if a third string is supplied, an extra holiday
is generated for the day after the full moon using that name."
  (declare (indent defun))
  `(defun ,name (year)
     (apply #'holiday-named-full-moons
            year
            (list ,@(mapcar (lambda (entry) `(list ,@entry))
                            month-entries)))))

(defun holiday-named-full-moons-current-year ()
  "Holiday list of named full moons for the current year.

Intended for use from `holiday-other-holidays'."
  (interactive)
  (holiday-named-full-moons
    '(12 "Cold Moon")
    '(2 "Magha (Sangha)")
    '(5 "Vesak (Buddha)")
    '(7 "Asalha (Dhamma)" "Vassa")
    '(10 "Pavarana")))

(provide 'holiday-buddhist)
;;; holiday-buddhist.el ends here.
; LocalWords:  buddhist
